{{ 'component-price.css' | asset_url | stylesheet_tag }}
{{ 'component-card.css' | asset_url | stylesheet_tag }}
{{ 'featured-products-slider.css' | asset_url | stylesheet_tag }}
{{ 'quick-add.css' | asset_url | stylesheet_tag }}
{{ 'component-slider.css' | asset_url | stylesheet_tag }}

<script src='{{ 'quick-add.js' | asset_url }}' defer='defer'></script>
<script src='{{ 'product-form.js' | asset_url }}' defer='defer'></script>

<script>
  (function () {
    class FeaturedProductsSlider extends HTMLElement {
      constructor() {
        super();
        this.init();
      }

      init() {
        // Esperar a que el slider-component esté inicializado
        setTimeout(() => {
          this.slider = this.querySelector('[id^="Slider-"]');
          this.sliderComponent = this.querySelector('slider-component');
          this.dots = this.querySelectorAll('.slider-counter__link--dots');

          if (!this.slider || !this.sliderComponent || !this.dots.length) {
            // Reintentar si no está listo
            setTimeout(() => this.init(), 100);
            return;
          }

          // Obtener referencias del slider-component
          this.sliderItems = this.sliderComponent.querySelectorAll('[id^="Slide-"]');
          this.sliderItemsToShow = Array.from(this.sliderItems).filter((element) => element.clientWidth > 0);

          if (this.sliderItemsToShow.length < 1) return;

          // Calcular el offset entre slides (igual que SliderComponent)
          if (this.sliderItemsToShow.length >= 2) {
            this.sliderItemOffset = this.sliderItemsToShow[1].offsetLeft - this.sliderItemsToShow[0].offsetLeft;
          } else {
            this.sliderItemOffset = this.sliderItemsToShow[0].offsetWidth;
          }

          // Obtener el número de slides desde el atributo data-slides-count
          const dotsContainer = this.querySelector('.slider-counter--dots');
          if (dotsContainer && dotsContainer.dataset.slidesCount) {
            this.totalSlides = parseInt(dotsContainer.dataset.slidesCount, 10);
          } else {
            // Fallback: calcular basado en productos y columnas visibles
            const sliderWidth = this.slider.clientWidth;
            const firstItemLeft = this.sliderItemsToShow[0].offsetLeft;
            const itemsPerPage = Math.floor((sliderWidth - firstItemLeft) / this.sliderItemOffset);
            this.totalSlides = Math.max(1, this.sliderItemsToShow.length - itemsPerPage + 1);
          }

          // Throttle para el scroll
          this.scrollTimeout = null;

          // Escuchar el evento slideChanged del slider-component
          this.sliderComponent.addEventListener('slideChanged', (e) => {
            if (e.detail && e.detail.currentPage) {
              this.updateDots(e.detail.currentPage);
            }
          });

          // Escuchar el scroll del slider directamente
          this.handleScroll = () => {
            clearTimeout(this.scrollTimeout);
            this.scrollTimeout = setTimeout(() => {
              this.updateDotsFromScroll();
            }, 50);
          };

          this.slider.addEventListener('scroll', this.handleScroll);

          // Agregar listeners a los dots para navegar
          this.dots.forEach((dot, index) => {
            dot.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              this.goToSlide(index);
            });
          });

          // Actualizar dots inicial
          setTimeout(() => {
            this.updateDotsFromScroll();
          }, 300);
        }, 100);
      }

      updateDotsFromScroll() {
        if (!this.slider || !this.sliderItemsToShow || this.sliderItemsToShow.length < 1) return;

        // Usar el mismo cálculo que SliderComponent para determinar la página actual
        let currentPage = 1;

        if (this.sliderItemOffset && this.sliderItemOffset > 0) {
          currentPage = Math.round(this.slider.scrollLeft / this.sliderItemOffset) + 1;
        } else {
          // Fallback: calcular basado en qué slide está más visible
          const sliderScrollLeft = this.slider.scrollLeft;
          const sliderWidth = this.slider.clientWidth;
          const centerPoint = sliderScrollLeft + sliderWidth / 2;

          let currentIndex = 0;
          let minDistance = Infinity;

          this.sliderItemsToShow.forEach((slide, index) => {
            const slideLeft = slide.offsetLeft;
            const slideWidth = slide.offsetWidth;
            const slideCenter = slideLeft + slideWidth / 2;
            const distance = Math.abs(slideCenter - centerPoint);

            if (distance < minDistance) {
              minDistance = distance;
              currentIndex = index;
            }
          });

          // Convertir índice de producto a índice de slide
          const firstItemLeft = this.sliderItemsToShow[0].offsetLeft;
          const sliderWidth2 = this.slider.clientWidth;
          const itemsPerPage = Math.floor(
            (sliderWidth2 - firstItemLeft) /
              (this.sliderItemsToShow[1]?.offsetLeft - this.sliderItemsToShow[0].offsetLeft ||
                this.sliderItemsToShow[0].offsetWidth),
          );
          currentPage = Math.floor(currentIndex / (itemsPerPage || 1)) + 1;
        }

        // Asegurar que currentPage esté dentro del rango válido
        currentPage = Math.max(1, Math.min(currentPage, this.totalSlides || this.dots.length));

        this.updateDots(currentPage);
      }

      updateDots(currentPage) {
        if (!currentPage || currentPage < 1 || !this.dots.length) return;

        // Asegurarse de que el índice esté dentro del rango válido
        const activeIndex = Math.min(currentPage - 1, this.dots.length - 1);

        this.dots.forEach((dot, index) => {
          if (index === activeIndex) {
            dot.classList.add('slider-counter__link--active');
            dot.setAttribute('aria-current', 'true');
          } else {
            dot.classList.remove('slider-counter__link--active');
            dot.removeAttribute('aria-current');
          }
        });
      }

      goToSlide(slideIndex) {
        if (!this.slider || !this.sliderItemsToShow || this.sliderItemsToShow.length < 1) return;

        // Calcular qué producto corresponde a este slide
        // Si hay 2 columnas, slide 0 = productos 0-1, slide 1 = productos 2-3, etc.
        const firstItemLeft = this.sliderItemsToShow[0].offsetLeft;
        const sliderWidth = this.slider.clientWidth;
        const itemsPerPage =
          this.sliderItemsToShow.length >= 2
            ? Math.floor(
                (sliderWidth - firstItemLeft) /
                  (this.sliderItemsToShow[1].offsetLeft - this.sliderItemsToShow[0].offsetLeft),
              )
            : 1;

        const productIndex = slideIndex * itemsPerPage;
        const targetSlide = this.sliderItemsToShow[productIndex];

        if (!targetSlide) return;

        const slideOffset = targetSlide.offsetLeft - this.slider.offsetLeft;

        // Actualizar dots inmediatamente para feedback visual
        this.updateDots(slideIndex + 1);

        this.slider.scrollTo({
          left: slideOffset,
          behavior: 'smooth',
        });

        // Actualizar dots después del scroll para asegurar sincronización
        setTimeout(() => {
          this.updateDotsFromScroll();
        }, 300);
      }
    }

    // Registrar el componente
    if (!customElements.get('featured-products-slider-section')) {
      customElements.define('featured-products-slider-section', FeaturedProductsSlider);
    }
  })();
</script>

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

{%- liquid
  assign products_count = section.blocks.size
  assign columns_mobile_int = 1
  assign show_mobile_slider = false
  if section.settings.swipe_on_mobile and products_count > columns_mobile_int
    assign show_mobile_slider = true
  endif

  assign show_desktop_slider = false
  if section.settings.enable_desktop_slider and products_count > section.settings.columns_desktop
    assign show_desktop_slider = true
  endif
-%}

<featured-products-slider-section class='featured-products-slider-section color-{{ section.settings.color_scheme }} gradient isolate'>
  {%- comment -%} Imagen de fondo hero {%- endcomment -%}
  {%- if section.settings.background_image != blank -%}
    <div class='featured-products-slider__hero'>
      <div class='featured-products-slider__hero-image'>
        {{
          section.settings.background_image
          | image_url: width: 1920
          | image_tag:
            loading: 'lazy',
            sizes: '100vw',
            widths: '375, 550, 750, 1100, 1500, 1780, 2000, 3000, 3840',
            alt: section.settings.background_image.alt
          | escape
        }}
      </div>
    </div>
  {%- endif -%}

  <div class='page-width section-{{ section.id }}-padding'>
    {%- comment -%} Header con título y subtítulo {%- endcomment -%}
    {%- if section.settings.title != blank or section.settings.subtitle != blank -%}
      <div class='featured-products-slider__header'>
        {%- if section.settings.title != blank -%}
          <h2 class='featured-products-slider__title'>
            {{ section.settings.title }}
          </h2>
        {%- endif -%}
        {%- if section.settings.subtitle != blank -%}
          <div class='featured-products-slider__subtitle'>
            {{ section.settings.subtitle }}
          </div>
        {%- endif -%}
      </div>
    {%- endif -%}

    {%- comment -%} Slider de productos {%- endcomment -%}
    {%- if section.blocks.size > 0 -%}
      <slider-component
        class='slider-mobile-gutter{% if show_mobile_slider == false %} page-width{% endif %}{% if show_desktop_slider == false %} page-width-desktop{% endif %}{% if show_desktop_slider %} slider-component-desktop{% endif %}'
        data-columns='{{ section.settings.columns_desktop }}'
      >
        <ul
          id='Slider-{{ section.id }}'
          data-id='{{ section.id }}'
          class='featured-products-slider__list tgrid grid--1-col-tablet-down grid--{{ section.settings.columns_desktop }}-col-desktop{% if show_mobile_slider or show_desktop_slider %} slider{% if show_desktop_slider %} slider--desktop{% endif %}{% if show_mobile_slider %} slider--tablet grid--peek{% endif %}{% endif %}'
          role='list'
          aria-label='{{ 'general.slider.name' | t }}'
        >
          {% assign skip_card_product_styles = false %}
          {%- for block in section.blocks -%}
            {%- if block.settings.product != blank -%}
              {%- assign product = block.settings.product -%}
              <li
                id='Slide-{{ section.id }}-{{ block.id }}'
                class='grid__item featured-products-slider__item{% if show_mobile_slider or show_desktop_slider %} slider__slide{% endif %}'
                {{ block.shopify_attributes }}
              >
                <div class='featured-products-slider__card'>
                  {%- comment -%} Imagen del producto a la izquierda {%- endcomment -%}
                  <div class='featured-products-slider__card-image'>
                    {%- if product.featured_media -%}
                      <a href='{{ product.url }}' class='featured-products-slider__image-link'>
                        {{
                          product.featured_media
                          | image_url: width: 600
                          | image_tag:
                            loading: 'lazy',
                            sizes: '(min-width: 990px) 300px, 50vw',
                            widths: '165, 360, 533, 720, 940, 1066',
                            alt: product.featured_media.alt
                          | escape
                        }}
                      </a>
                    {%- endif -%}
                  </div>

                  {%- comment -%} Contenido a la derecha {%- endcomment -%}
                  <div class='featured-products-slider__card-content'>
                    <div class='featured-products-slider__card-info'>
                      {%- comment -%} Título del producto {%- endcomment -%}
                      <h3 class='featured-products-slider__card-title'>
                        <a href='{{ product.url }}' class='featured-products-slider__card-title-link'>
                          {{ product.title | escape }}
                        </a>
                      </h3>

                      {%- comment -%} Descripción truncada {%- endcomment -%}
                      {%- if product.description != blank -%}
                        <div class='featured-products-slider__card-description'>
                          {{ product.description | strip_html | truncatewords: 15 }}
                        </div>
                      {%- endif -%}

                      {%- comment -%} Precio {%- endcomment -%}
                      <div class='featured-products-slider__card-price'>
                        {% render 'price',
                          product: product,
                          price_class: 'featured-products-slider__price',
                          show_compare_at_price: true
                        %}
                      </div>

                      {%- comment -%} Botón agregar al carrito {%- endcomment -%}
                      {% assign product_form_id = 'quick-add-'
                        | append: section.id
                        | append: '-'
                        | append: product.id
                      %}
                      {%- if product.variants.size > 1 -%}
                        <modal-opener data-modal='#QuickAdd-{{ product.id }}-{{ section.id }}'>
                          <button
                            id='{{ product_form_id }}-submit'
                            type='submit'
                            name='add'
                            class='featured-products-slider__button card__quick-action-button card__quick-action-button--secondary quick-add__submit button button--full-width button--secondary'
                            aria-haspopup='dialog'
                            aria-labelledby='{{ product_form_id }}-submit title-{{ section.id }}-{{ product.id }}'
                            data-product-url='{{ product.url }}'
                          >
                            <span class='card__quick-action-text'>
                              {{ 'products.product.choose_options' | t }}
                            </span>
                            <span class='card__quick-action-icon'>
                              {{- 'icon-arrow.svg' | inline_asset_content -}}
                            </span>
                            {%- render 'loading-spinner' -%}
                          </button>
                        </modal-opener>
                        <quick-add-modal id='QuickAdd-{{ product.id }}-{{ section.id }}' class='quick-add-modal'>
                          <div
                            role='dialog'
                            aria-label='{{ 'products.product.choose_product_options' | t: product_name: product.title | escape }}'
                            aria-modal='true'
                            class='quick-add-modal__content global-settings-popup'
                            tabindex='-1'
                          >
                            <button
                              id='ModalClose-{{ product.id }}-{{ section.id }}'
                              type='button'
                              class='quick-add-modal__toggle'
                              aria-label='{{ 'accessibility.close' | t }}'
                            >
                              {{- 'icon-close.svg' | inline_asset_content -}}
                            </button>
                            <div
                              id='QuickAddInfo-{{ product.id }}-{{ section.id }}'
                              class='quick-add-modal__content-info'
                            ></div>
                          </div>
                        </quick-add-modal>
                      {%- else -%}
                        <product-form data-section-id='{{ section.id }}'>
                          {%- form 'product',
                            product,
                            id: product_form_id,
                            class: 'form',
                            novalidate: 'novalidate',
                            data-type: 'add-to-cart-form'
                          -%}
                            <input
                              type='hidden'
                              name='id'
                              value='{{ product.selected_or_first_available_variant.id }}'
                              class='product-variant-id'
                              {% if product.selected_or_first_available_variant.available == false %}
                                disabled
                              {% endif %}
                            >
                            <button
                              id='{{ product_form_id }}-submit'
                              type='submit'
                              name='add'
                              class='featured-products-slider__button card__quick-action-button card__quick-action-button--primary card__add-to-cart-btn quick-add__submit button button--full-width'
                              aria-haspopup='dialog'
                              aria-labelledby='{{ product_form_id }}-submit title-{{ section.id }}-{{ product.id }}'
                              aria-live='polite'
                              data-sold-out-message='true'
                              {% if product.selected_or_first_available_variant.available == false %}
                                disabled
                              {% endif %}
                            >
                              <span class='card__quick-action-text card__add-to-cart-text'>
                                {%- if product.selected_or_first_available_variant.available -%}
                                  AGREGAR AL CARRITO
                                {%- else -%}
                                  {{ 'products.product.sold_out' | t }}
                                {%- endif -%}
                              </span>
                              <span class='sold-out-message hidden'>
                                {{ 'products.product.sold_out' | t }}
                              </span>
                              <span class='card__quick-action-icon card__add-to-cart-icon'>
                                {{- 'icon-plus.svg' | inline_asset_content -}}
                              </span>
                              {%- render 'loading-spinner' -%}
                            </button>
                          {%- endform -%}
                        </product-form>
                      {%- endif -%}
                    </div>
                  </div>
                </div>
              </li>
              {%- assign skip_card_product_styles = true -%}
            {%- endif -%}
          {%- endfor -%}
        </ul>

        {%- comment -%} Controles del slider {%- endcomment -%}
        {%- if show_mobile_slider or show_desktop_slider -%}
          {%- comment -%} Calcular el número de slides basado en productos y columnas {%- endcomment -%}
          {%- liquid
            assign slides_count = products_count
            if show_desktop_slider and section.settings.columns_desktop > 1
              assign slides_count = products_count | divided_by: section.settings.columns_desktop
              assign remainder = products_count | modulo: section.settings.columns_desktop
              if remainder > 0
                assign slides_count = slides_count | plus: 1
              endif
            endif
          -%}
          <div class='slider-buttons'>
            <button
              type='button'
              class='slider-button slider-button--prev'
              name='previous'
              aria-label='{{ 'general.slider.previous_slide' | t }}'
              aria-controls='Slider-{{ section.id }}'
            >
              <span class='svg-wrapper'>
                {{- 'icon-caret.svg' | inline_asset_content -}}
              </span>
            </button>
            <div class='slider-counter slider-counter--dots' data-slides-count='{{ slides_count }}'>
              {%- comment -%} Generar dots basado en el número de slides, no productos {%- endcomment -%}
              {%- for i in (1..slides_count) -%}
                <button
                  class='slider-counter__link slider-counter__link--dots link{% if forloop.first %} slider-counter__link--active{% endif %}'
                  aria-label='{{ 'general.slider.load_slide' | t }} {{ forloop.index }} {{ 'general.slider.of' | t }} {{ slides_count }}'
                  aria-controls='Slider-{{ section.id }}'
                  data-slide-index='{{ forloop.index0 }}'
                >
                  <span class='dot'></span>
                </button>
              {%- endfor -%}
            </div>
            <button
              type='button'
              class='slider-button slider-button--next'
              name='next'
              aria-label='{{ 'general.slider.next_slide' | t }}'
              aria-controls='Slider-{{ section.id }}'
            >
              <span class='svg-wrapper'>
                {{- 'icon-caret.svg' | inline_asset_content -}}
              </span>
            </button>
          </div>
        {%- endif -%}
      </slider-component>
    {%- endif -%}
  </div>
</featured-products-slider-section>

{% schema %}
{
  "name": "Destacados Jugada",
  "tag": "section",
  "class": "section",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Imagen de fondo",
      "info": "Imagen hero que aparece detrás del contenido"
    },
    {
      "type": "inline_richtext",
      "id": "title",
      "label": "Título",
      "default": "En la jugada"
    },
    {
      "type": "richtext",
      "id": "subtitle",
      "label": "Subtítulo",
      "default": "<p>Si está aquí, es porque los mecánicos y motociclistas ya lo descubrieron. No te quedes atrás.</p>"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 1,
      "max": 4,
      "step": 1,
      "default": 2,
      "label": "Productos visibles en desktop"
    },
    {
      "type": "checkbox",
      "id": "enable_desktop_slider",
      "label": "Activar slider en desktop",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "swipe_on_mobile",
      "label": "Activar swipe en mobile",
      "default": true
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Esquema de color",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Espaciado"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Espaciado superior",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Espaciado inferior",
      "default": 36
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Producto",
      "limit": 20,
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Producto",
          "info": "Selecciona un producto para mostrar en el slider"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Destacados Jugada",
      "blocks": [
        {
          "type": "product"
        },
        {
          "type": "product"
        }
      ]
    }
  ]
}
{% endschema %}
